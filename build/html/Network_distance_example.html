

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Network distance tying it all together &mdash; GIS Exploration 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Network Distance with LION map (weight)" href="networkdistance_lion-issues.html" />
    <link rel="prev" title="Network Distance with LION map" href="networkdistance_lion.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> GIS Exploration
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="networkdistance_osm.html">Network distance</a></li>
<li class="toctree-l1"><a class="reference internal" href="networkdistance_lion.html">Network Distance with LION map</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Network distance tying it all together</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Get-the-2019-“NYC-LION-Single-Line-Street-Base-Map”">Get the 2019 “NYC LION Single Line Street Base Map”</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Getting-the-public-school-location-data-from-NYC-Open-Data">Getting the public school location data from NYC Open Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Getting-the-subway-information">Getting the subway information</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Adding-these-points-into-the-street-network">Adding these points into the street network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Reading-in-the-modified-street-network">Reading in the modified street network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Convert-to-undirected-graph">Convert to undirected graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Locating-the-nodes-for-each-location">Locating the nodes for each location</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Finding-the-nearest-2-subway-entrances">Finding the nearest 2 subway entrances</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Network-distance">Network distance</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Plot-the-schools,-subway-and-routes">Plot the schools, subway and routes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="networkdistance_lion-issues.html">Network Distance with LION map (weight)</a></li>
<li class="toctree-l1"><a class="reference internal" href="snapping_points_to_line.html">Snapping points to line</a></li>
<li class="toctree-l1"><a class="reference internal" href="Extracting_lion.html">Extracting LION from BYTES of the BIG APPLE</a></li>
<li class="toctree-l1"><a class="reference internal" href="zoomed_inset_axes.html">Using matplotlib’s zoomed_inset_axes with geopandas</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GIS Exploration</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Network distance tying it all together</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Network_distance_example.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Network-distance-tying-it-all-together">
<h1>Network distance tying it all together<a class="headerlink" href="#Network-distance-tying-it-all-together" title="Permalink to this headline">¶</a></h1>
<p>Here, we will calculate the walking distance for students in public schools to their nearest subway entrance.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">box</span><span class="p">,</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span><span class="n">MultiPoint</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">cKDTree</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="k">import</span> <span class="n">ZipFile</span> <span class="k">as</span> <span class="n">zzip</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">rtree</span> <span class="k">import</span> <span class="n">index</span>
<span class="kn">import</span> <span class="nn">rtree</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">shapely</span> <span class="k">import</span> <span class="n">wkt</span>
<span class="kn">from</span> <span class="nn">shapely.ops</span> <span class="k">import</span> <span class="n">split</span><span class="p">,</span> <span class="n">snap</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&#39;C:\\Work\\Box Sync\\GIS_exploration\\code&#39;
</pre></div>
</div>
</div>
<div class="section" id="Get-the-2019-“NYC-LION-Single-Line-Street-Base-Map”">
<h2>Get the 2019 “NYC LION Single Line Street Base Map”<a class="headerlink" href="#Get-the-2019-“NYC-LION-Single-Line-Street-Base-Map”" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">url</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;https://www1.nyc.gov/assets/planning/download/zip/data-maps/open-data/nyclion_19b.zip&quot;</span>
<span class="n">filename</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;nyclion_19b.zip&quot;</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="c1"># open method to open a file on your system and write the contents</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../input_data/&quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;../input_data/&quot;</span>
<span class="n">foldername</span> <span class="o">=</span> <span class="s2">&quot;nyclion_19b&quot;</span>
<span class="k">with</span> <span class="n">zzip</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="c1">#printing all the contents of the zip file</span>
        <span class="c1">#file.printdir()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;../input_data/&quot;</span><span class="o">+</span><span class="n">foldername</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># extracting all the files</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extracting all the files now...&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">foldername</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
File Name                                             Modified             Size
lion/lion.gdb/a00000001.freelist               2019-05-13 12:48:56         4440
lion/lion.gdb/a00000001.gdbindexes             2019-05-13 12:42:56          110
lion/lion.gdb/a00000001.gdbtable               2019-05-13 12:48:56          385
lion/lion.gdb/a00000001.gdbtablx               2019-05-13 12:48:56         5152
lion/lion.gdb/a00000001.TablesByName.atx       2019-05-13 12:48:56         4118
lion/lion.gdb/a00000002.gdbtable               2019-05-13 12:42:56         2055
lion/lion.gdb/a00000002.gdbtablx               2019-05-13 12:42:56         5152
lion/lion.gdb/a00000003.gdbindexes             2019-05-13 12:42:56           42
lion/lion.gdb/a00000003.gdbtable               2019-05-13 12:44:22         1825
lion/lion.gdb/a00000003.gdbtablx               2019-05-13 12:44:22         5152
lion/lion.gdb/a00000004.CatItemsByPhysicalName.atx 2019-05-13 12:48:56         4118
lion/lion.gdb/a00000004.CatItemsByType.atx     2019-05-13 12:48:56         4118
lion/lion.gdb/a00000004.FDO_UUID.atx           2019-05-13 12:48:56         4118
lion/lion.gdb/a00000004.freelist               2019-05-13 12:49:38        57688
lion/lion.gdb/a00000004.gdbindexes             2019-05-13 12:42:56          310
lion/lion.gdb/a00000004.gdbtable               2019-05-13 12:49:38       399741
lion/lion.gdb/a00000004.gdbtablx               2019-05-13 12:49:38         5152
lion/lion.gdb/a00000004.spx                    2019-05-13 12:49:30        45078
lion/lion.gdb/a00000005.CatItemTypesByName.atx 2019-05-13 12:42:56        12310
lion/lion.gdb/a00000005.CatItemTypesByParentTypeID.atx 2019-05-13 12:42:56         4118
lion/lion.gdb/a00000005.CatItemTypesByUUID.atx 2019-05-13 12:42:56         4118
lion/lion.gdb/a00000005.gdbindexes             2019-05-13 12:42:56          296
lion/lion.gdb/a00000005.gdbtable               2019-05-13 12:42:56         1803
lion/lion.gdb/a00000005.gdbtablx               2019-05-13 12:42:56         5152
lion/lion.gdb/a00000006.CatRelsByDestinationID.atx 2019-05-13 12:48:56         4118
lion/lion.gdb/a00000006.CatRelsByOriginID.atx  2019-05-13 12:48:56         4118
lion/lion.gdb/a00000006.CatRelsByType.atx      2019-05-13 12:48:56         4118
lion/lion.gdb/a00000006.FDO_UUID.atx           2019-05-13 12:48:56         4118
lion/lion.gdb/a00000006.freelist               2019-05-13 12:48:56         4440
lion/lion.gdb/a00000006.gdbindexes             2019-05-13 12:42:56          318
lion/lion.gdb/a00000006.gdbtable               2019-05-13 12:48:56          701
lion/lion.gdb/a00000006.gdbtablx               2019-05-13 12:48:56         5152
lion/lion.gdb/a00000007.CatRelTypesByBackwardLabel.atx 2019-05-13 12:42:56         4118
lion/lion.gdb/a00000007.CatRelTypesByDestItemTypeID.atx 2019-05-13 12:42:56         4118
lion/lion.gdb/a00000007.CatRelTypesByForwardLabel.atx 2019-05-13 12:42:56         4118
lion/lion.gdb/a00000007.CatRelTypesByName.atx  2019-05-13 12:42:56         4118
lion/lion.gdb/a00000007.CatRelTypesByOriginItemTypeID.atx 2019-05-13 12:42:56         4118
lion/lion.gdb/a00000007.CatRelTypesByUUID.atx  2019-05-13 12:42:56         4118
lion/lion.gdb/a00000007.gdbindexes             2019-05-13 12:42:56          602
lion/lion.gdb/a00000007.gdbtable               2019-05-13 12:42:56         2504
lion/lion.gdb/a00000007.gdbtablx               2019-05-13 12:42:56         5152
lion/lion.gdb/a0000000a.gdbindexes             2019-05-13 12:44:48          116
lion/lion.gdb/a0000000a.gdbtable               2019-05-13 12:44:48      3247250
lion/lion.gdb/a0000000a.gdbtablx               2019-05-13 12:44:48       665632
lion/lion.gdb/a0000000a.spx                    2019-05-13 12:44:48      1609750
lion/lion.gdb/a0000000b.gdbindexes             2019-05-13 12:44:56           66
lion/lion.gdb/a0000000b.gdbtable               2019-05-13 12:45:24      5491953
lion/lion.gdb/a0000000b.gdbtablx               2019-05-13 12:45:24      1172512
lion/lion.gdb/a0000000c.gdbindexes             2019-05-13 12:45:30           66
lion/lion.gdb/a0000000c.gdbtable               2019-05-13 12:45:42      6406110
lion/lion.gdb/a0000000c.gdbtablx               2019-05-13 12:45:42       527392
lion/lion.gdb/a0000000d.freelist               2019-05-13 12:48:44        20824
lion/lion.gdb/a0000000d.gdbindexes             2019-05-13 12:48:30          116
lion/lion.gdb/a0000000d.gdbtable               2019-05-13 12:48:44    126137796
lion/lion.gdb/a0000000d.gdbtablx               2019-05-13 12:48:44      1136672
lion/lion.gdb/a0000000d.spx                    2019-05-13 12:48:30      4362262
lion/lion.gdb/gdb                              2019-05-13 12:42:56            4
lion/lion.gdb/timestamps                       2019-05-13 12:47:14          400
lion/LION - Street Name Labels.lyr             2013-09-24 18:10:22        18432
lion/LION Streets - Generic.lyr                2017-02-10 07:51:36        21504
lion/LION Streets - Roadbeds.lyr               2017-02-10 07:54:38        21504
lion/LION - Generic.lyr                        2017-02-10 07:48:08        24576
lion/LION - Roadbeds.lyr                       2017-02-10 07:49:32        24576
lion/LION - Nodes.lyr                          2012-08-17 13:19:50        11776
lion/LION - Street Direction Arrows (ArcGIS 10x).lyr 2013-01-15 10:58:06        22528
lion/LION - Street Direction Arrows (Requires Maplex).lyr 2013-03-12 14:22:44        22528
lion/TrafficRepArrows.style                    2012-09-27 08:32:40       598016
lion/ReadMe.txt                                2014-03-17 15:27:04         7758
altnames_metadata.html                         2019-05-13 12:49:22        38976
altnames_metadata.pdf                          2019-05-13 14:35:58       129541
lion_metadata.html                             2019-05-13 12:49:12       199830
lion_metadata.pdf                              2019-05-13 14:35:22       483768
node_metadata.html                             2019-05-13 12:49:32        42396
node_metadata.pdf                              2019-05-13 14:34:28       135027
node_stname_metadata.html                      2019-05-13 12:49:40        32999
node_stname_metadata.pdf                       2019-05-13 14:36:56       123835
Extracting all the files now...
Done!
</pre></div></div>
</div>
<p>Reading the lion layer into a geopandas dataframe</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;../input_data/nyclion_19b/lion/lion.gdb&quot;</span>
<span class="n">lion_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;FileGDB&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;lion&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Removing the non pedestrian accessible roads/paths</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lion_gdf</span><span class="p">[</span><span class="s1">&#39;todrop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lion_gdf</span><span class="p">[</span><span class="s1">&#39;NonPed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">)</span> <span class="o">|</span><span class="p">(</span><span class="n">lion_gdf</span><span class="p">[</span><span class="s1">&#39;FeatureTyp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">]))</span> <span class="o">|</span><span class="p">(</span><span class="n">lion_gdf</span><span class="p">[</span><span class="s1">&#39;TrafDir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39; &#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lion_gdf</span> <span class="o">=</span> <span class="n">lion_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lion_gdf</span><span class="p">[</span><span class="s1">&#39;todrop&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lion_gdf</span><span class="o">.</span><span class="n">crs</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>{&#39;init&#39;: &#39;epsg:2263&#39;}
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lion_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/Network_distance_example_12_0.png" src="_images/Network_distance_example_12_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lion_gdf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Street</th>
      <th>SAFStreetName</th>
      <th>FeatureTyp</th>
      <th>SegmentTyp</th>
      <th>IncExFlag</th>
      <th>RB_Layer</th>
      <th>NonPed</th>
      <th>TrafDir</th>
      <th>TrafSrc</th>
      <th>SpecAddr</th>
      <th>...</th>
      <th>RLo_Hyphen</th>
      <th>RHi_Hyphen</th>
      <th>FromLeft</th>
      <th>ToLeft</th>
      <th>FromRight</th>
      <th>ToRight</th>
      <th>Join_ID</th>
      <th>SHAPE_Length</th>
      <th>geometry</th>
      <th>todrop</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>EAST 168 STREET</td>
      <td></td>
      <td>0</td>
      <td>U</td>
      <td></td>
      <td>B</td>
      <td></td>
      <td>T</td>
      <td>DOT</td>
      <td></td>
      <td>...</td>
      <td>596</td>
      <td>716</td>
      <td>599</td>
      <td>699</td>
      <td>596</td>
      <td>716</td>
      <td>2251001000000</td>
      <td>396.030947</td>
      <td>(LINESTRING (1010964.446978778 241812.26140345...</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>WEST 192 STREET</td>
      <td></td>
      <td>0</td>
      <td>U</td>
      <td></td>
      <td>B</td>
      <td></td>
      <td>A</td>
      <td>DOT</td>
      <td></td>
      <td>...</td>
      <td>63</td>
      <td>99</td>
      <td>58</td>
      <td>98</td>
      <td>63</td>
      <td>99</td>
      <td>2798401000000</td>
      <td>279.360514</td>
      <td>(LINESTRING (1011576.686607853 255023.58303095...</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>UNION AVENUE</td>
      <td></td>
      <td>0</td>
      <td>U</td>
      <td></td>
      <td>B</td>
      <td></td>
      <td>W</td>
      <td>DOT</td>
      <td></td>
      <td>...</td>
      <td>1016</td>
      <td>1084</td>
      <td>1017</td>
      <td>1079</td>
      <td>1016</td>
      <td>1084</td>
      <td>2728001000000</td>
      <td>618.327133</td>
      <td>(LINESTRING (1011600.676209003 239639.74280026...</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>UNION AVENUE</td>
      <td>BEHAGEN PLAYGROUND</td>
      <td>0</td>
      <td>U</td>
      <td></td>
      <td>B</td>
      <td></td>
      <td>W</td>
      <td>DOT</td>
      <td>N</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>21279501000000N</td>
      <td>618.327133</td>
      <td>(LINESTRING (1011600.676209003 239639.74280026...</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>DELAFIELD AVENUE</td>
      <td></td>
      <td>6</td>
      <td>U</td>
      <td></td>
      <td>B</td>
      <td></td>
      <td>T</td>
      <td>DOT</td>
      <td></td>
      <td>...</td>
      <td>4600</td>
      <td>4664</td>
      <td>4601</td>
      <td>4645</td>
      <td>4600</td>
      <td>4664</td>
      <td>2187601000000</td>
      <td>670.281037</td>
      <td>(LINESTRING (1009974.212831751 264857.13919802...</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 119 columns</p>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../intermediate_data/nyclion_19b/&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="n">lion_gdf</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="s2">&quot;nyclion_19b.shp&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Getting-the-public-school-location-data-from-NYC-Open-Data">
<h2>Getting the public school location data from NYC Open Data<a class="headerlink" href="#Getting-the-public-school-location-data-from-NYC-Open-Data" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">url</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;https://data.cityofnewyork.us/download/jfju-ynrr/application</span><span class="si">%2F</span><span class="s2">zip&quot;</span>
<span class="n">filename</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Public_School_Locations.zip&quot;</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="c1"># open method to open a file on your system and write the contents</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../input_data/&quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;../input_data/&quot;</span>
<span class="n">foldername</span> <span class="o">=</span> <span class="s2">&quot;Public_School_Locations&quot;</span>
<span class="k">with</span> <span class="n">zzip</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="c1"># printing all the contents of the zip file</span>
        <span class="n">file</span><span class="o">.</span><span class="n">printdir</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;../input_data/&quot;</span><span class="o">+</span><span class="n">foldername</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># extracting all the files</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extracting all the files now...&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="n">foldername</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
File Name                                             Modified             Size
Public_Schools_Points_2011-2012A.dbf           2011-08-26 10:30:16       771337
Public_Schools_Points_2011-2012A.prj           2010-10-12 11:55:12          562
Public_Schools_Points_2011-2012A.sbn           2011-08-03 11:23:00        16580
Public_Schools_Points_2011-2012A.sbx           2011-08-03 11:23:00          868
Public_Schools_Points_2011-2012A.shp           2011-08-03 11:23:00        47952
Public_Schools_Points_2011-2012A.shp.xml       2011-08-26 10:32:50        28413
Public_Schools_Points_2011-2012A.shx           2011-08-03 11:23:00        13772
Extracting all the files now...
Done!
</pre></div></div>
</div>
<p>Read the school point shapefile into a geopandas geodataframe</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;../input_data/Public_School_Locations/Public_Schools_Points_2011-2012A.shp&quot;</span>
<span class="n">schools</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">crs</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>{&#39;init&#39;: &#39;epsg:2263&#39;}
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ATS_CODE</th>
      <th>BORO</th>
      <th>BORONUM</th>
      <th>LOC_CODE</th>
      <th>SCHOOLNAME</th>
      <th>SCH_TYPE</th>
      <th>MANAGED_BY</th>
      <th>GEO_DISTRI</th>
      <th>ADMIN_DIST</th>
      <th>ADDRESS</th>
      <th>STATE_CODE</th>
      <th>ZIP</th>
      <th>PRINCIPAL</th>
      <th>PRIN_PH</th>
      <th>FAX</th>
      <th>GRADES</th>
      <th>City</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>15K001</td>
      <td>K</td>
      <td>2.0</td>
      <td>K001</td>
      <td>P.S. 001 THE BERGEN</td>
      <td>Elementary</td>
      <td>1</td>
      <td>15</td>
      <td>15</td>
      <td>309 47 STREET</td>
      <td>NY</td>
      <td>11220</td>
      <td>Jennifer Eusanio</td>
      <td>718-567-7661</td>
      <td>718-567-9771</td>
      <td>PK,0K,01,02,03,04,05,SE</td>
      <td>BROOKLYN</td>
      <td>POINT (980985.0541713729 175780.758994163)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>17K002</td>
      <td>K</td>
      <td>2.0</td>
      <td>K002</td>
      <td>M.S. 002</td>
      <td>Junior High-Intermediate-Middle</td>
      <td>1</td>
      <td>17</td>
      <td>17</td>
      <td>655 PARKSIDE AVENUE</td>
      <td>NY</td>
      <td>11226</td>
      <td>ADRIENNE SPENCER</td>
      <td>718-462-6992</td>
      <td>718-284-7717</td>
      <td>06,07,08,SE</td>
      <td>BROOKLYN</td>
      <td>POINT (997785.1364296663 178431.910832498)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>21K095</td>
      <td>K</td>
      <td>2.0</td>
      <td>K095</td>
      <td>P.S. 095 THE GRAVESEND</td>
      <td>K-8</td>
      <td>1</td>
      <td>21</td>
      <td>21</td>
      <td>345 VAN SICKLEN STREET</td>
      <td>NY</td>
      <td>11223</td>
      <td>Janet Ndzibah</td>
      <td>718-449-5050</td>
      <td>718-449-3047</td>
      <td>PK,0K,01,02,03,04,05,06,07,08,SE</td>
      <td>BROOKLYN</td>
      <td>POINT (991224.9830063033 156323.3612131244)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>21K096</td>
      <td>K</td>
      <td>2.0</td>
      <td>K096</td>
      <td>I.S. 096 SETH LOW</td>
      <td>Junior High-Intermediate-Middle</td>
      <td>1</td>
      <td>21</td>
      <td>21</td>
      <td>99 AVENUE P</td>
      <td>NY</td>
      <td>11204</td>
      <td>Denise Sandra Levinsky</td>
      <td>718-236-1344</td>
      <td>718-236-2397</td>
      <td>06,07,08,SE</td>
      <td>BROOKLYN</td>
      <td>POINT (988439.6813609767 160709.9926236183)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>21K097</td>
      <td>K</td>
      <td>2.0</td>
      <td>K097</td>
      <td>P.S. 97 THE HIGHLAWN</td>
      <td>Elementary</td>
      <td>1</td>
      <td>21</td>
      <td>21</td>
      <td>1855 STILLWELL AVENUE</td>
      <td>NY</td>
      <td>11223</td>
      <td>KRISTINE MUSTILLO</td>
      <td>718-372-7393</td>
      <td>718-372-3842</td>
      <td>PK,0K,01,02,03,04,05,SE</td>
      <td>BROOKLYN</td>
      <td>POINT (988205.0729096507 158329.5913366843)</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[115]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;BORONUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[115]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>2.0    902
1.0    348
4.0    341
5.0     73
3.0     43
0.0      2
Name: BORONUM, dtype: int64
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[170]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/Network_distance_example_23_0.png" src="_images/Network_distance_example_23_0.png" />
</div>
</div>
</div>
<div class="section" id="Getting-the-subway-information">
<h2>Getting the subway information<a class="headerlink" href="#Getting-the-subway-information" title="Permalink to this headline">¶</a></h2>
<p>Read the subway entract shapefile into a geopandas geodataframe</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;https://data.cityofnewyork.us/api/geospatial/drex-xx56?method=export&amp;format=Shapefile&quot;</span>
<span class="n">subway</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">subway</span><span class="o">.</span><span class="n">crs</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>{&#39;init&#39;: &#39;epsg:4326&#39;}
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">subway</span> <span class="o">=</span> <span class="n">subway</span><span class="o">.</span><span class="n">to_crs</span><span class="p">({</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:2263&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">subway</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>line</th>
      <th>name</th>
      <th>objectid</th>
      <th>url</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2-5</td>
      <td>Birchall Ave &amp; Sagamore St at NW corner</td>
      <td>1734.0</td>
      <td>http://web.mta.info/nyct/service/</td>
      <td>POINT (1020670.668616476 248679.9905504963)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2-5</td>
      <td>Birchall Ave &amp; Sagamore St at NE corner</td>
      <td>1735.0</td>
      <td>http://web.mta.info/nyct/service/</td>
      <td>POINT (1020710.253511059 248665.112299423)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2-5</td>
      <td>Morris Park Ave &amp; 180th St at NW corner</td>
      <td>1736.0</td>
      <td>http://web.mta.info/nyct/service/</td>
      <td>POINT (1019251.986414479 245782.8697043241)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2-5</td>
      <td>Morris Park Ave &amp; 180th St at NW corner</td>
      <td>1737.0</td>
      <td>http://web.mta.info/nyct/service/</td>
      <td>POINT (1019419.817771734 245866.9102186682)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2-5</td>
      <td>Boston Rd &amp; 178th St at SW corner</td>
      <td>1738.0</td>
      <td>http://web.mta.info/nyct/service/</td>
      <td>POINT (1017557.721758398 245631.8322767556)</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">subway</span> <span class="o">=</span> <span class="n">subway</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">subway</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subway</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[168]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">subway</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/Network_distance_example_32_0.png" src="_images/Network_distance_example_32_0.png" />
</div>
</div>
</div>
<div class="section" id="Adding-these-points-into-the-street-network">
<h2>Adding these points into the street network<a class="headerlink" href="#Adding-these-points-into-the-street-network" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../intermediate_data/nyclion_19b/&quot;</span>
<span class="n">lion_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">read_shp</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="s2">&quot;nyclion_19b.shp&quot;</span><span class="p">,</span> <span class="n">simplify</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">geom_attrs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">strict</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../intermediate_data/nyclion_19b/&quot;</span>
<span class="n">nx</span><span class="o">.</span><span class="n">write_shp</span><span class="p">(</span><span class="n">lion_graph</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../intermediate_data/nyclion_19b/&quot;</span>
<span class="c1"># load as GeoDataFrame</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="s1">&#39;nodes.shp&#39;</span><span class="p">)</span>
<span class="n">edges</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="s1">&#39;edges.shp&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nodes</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:2263&#39;</span><span class="p">}</span>
<span class="n">edges</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:2263&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Create a point geopandas dataframe of these points.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">points_to_add</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">subway</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schools</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]],</span> <span class="n">sort</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span> <span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:2263&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">points_to_add</span> <span class="o">=</span> <span class="n">points_to_add</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">points_to_add</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_to_add</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<p>This AWESOME function <code class="docutils literal notranslate"><span class="pre">connect_poi()</span></code> is adapted from <a class="reference external" href="https://github.com/ywnch/toolbox">Yuwen Chang</a></p>
<p>This is slightly modified from Yuwen’s version.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">connect_poi</span><span class="p">(</span><span class="n">pois</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">key_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">knn</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Connect and integrate a set of POIs into an existing road network.</span>
<span class="sd">    Given a road network in the form of two GeoDataFrames: nodes and edges,</span>
<span class="sd">    link each POI to the nearest edge (road segment) based on its projection</span>
<span class="sd">    point (PP) and generate a new integrated road network including the POIs,</span>
<span class="sd">    the projected points, and the connection edge.</span>
<span class="sd">    Args:</span>
<span class="sd">        pois (GeoDataFrame): a gdf of POI (geom: Point)</span>
<span class="sd">        nodes (GeoDataFrame): a gdf of road network nodes (geom: Point)</span>
<span class="sd">        edges (GeoDataFrame): a gdf of road network edges (geom: LineString)</span>
<span class="sd">        key_col (str): a unique key column of pois should be provided,</span>
<span class="sd">                       e.g., &#39;index&#39;, &#39;osmid&#39;, &#39;poi_number&#39;, etc.</span>
<span class="sd">                       Currently, this will be renamed into &#39;osmid&#39; in the output.</span>
<span class="sd">                       [NOTE] For use in pandana, you may want to ensure this</span>
<span class="sd">                              column is numeric-only to avoid processing errors.</span>
<span class="sd">                              Preferably use unique integers (int or str) only,</span>
<span class="sd">                              and be aware not to intersect with the node key,</span>
<span class="sd">                              &#39;osmid&#39; if you use OSM data, in the nodes gdf.</span>
<span class="sd">        path (str): directory path to use for saving files (nodes and edges).</span>
<span class="sd">                      Outputs will NOT be saved if this arg is not specified.</span>
<span class="sd">        threshold (int): the max length of a POI connection edge, POIs with</span>
<span class="sd">                         connection edge beyond this length will be removed.</span>
<span class="sd">                         The unit is in meters as crs epsg is set to 3857 by</span>
<span class="sd">                         default during processing.</span>
<span class="sd">        knn (int): k nearest neighbors to query for the nearest edge.</span>
<span class="sd">                   Consider increasing this number up to 10 if the connection</span>
<span class="sd">                   output is slightly unreasonable. But higher knn number will</span>
<span class="sd">                   slow down the process.</span>
<span class="sd">    Returns:</span>
<span class="sd">        nodes (GeoDataFrame): the original gdf with POIs and PPs appended</span>
<span class="sd">        edges (GeoDataFrame): the original gdf with connection edges appended</span>
<span class="sd">                              and existing edges updated (if PPs are present)</span>
<span class="sd">    Note:</span>
<span class="sd">        1. Make sure all three input GeoDataFrames have defined crs attribute.</span>
<span class="sd">           Try something like `gdf.crs` or `gdf.crs = {&#39;init&#39;: &#39;epsg:4326&#39;}`.</span>
<span class="sd">           They will then be converted into epsg:3857 for processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## STAGE 0: initialization</span>
    <span class="c1"># 0-1: helper functions</span>
    <span class="k">def</span> <span class="nf">find_kne</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">),</span> <span class="n">lines</span><span class="p">)))</span>
        <span class="n">kne_pos</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">kne</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">kne_pos</span><span class="p">]]</span>
        <span class="n">kne_idx</span> <span class="o">=</span> <span class="n">kne</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">kne_idx</span><span class="p">,</span> <span class="n">kne</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_pp</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the projected point (pp) of &#39;point&#39; on &#39;line&#39;.&quot;&quot;&quot;</span>
        <span class="c1"># project new Point to be interpolated</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>  <span class="c1"># PP as a Point</span>
        <span class="k">return</span> <span class="n">pp</span>

    <span class="k">def</span> <span class="nf">split_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split &#39;line&#39; by all intersecting &#39;pps&#39; (as multipoint).</span>
<span class="sd">        Returns:</span>
<span class="sd">            new_lines (list): a list of all line segments after the split</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># IMPORTANT FIX for ensuring intersection between splitters and the line</span>
        <span class="c1"># but no need for updating edges_meter manually because the old lines will be</span>
        <span class="c1"># replaced anyway</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">snap</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pps</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>  <span class="c1"># slow?</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pps</span><span class="p">))</span>  <span class="c1"># split into segments</span>
            <span class="k">return</span> <span class="n">new_lines</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error when splitting line: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">pps</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">update_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">new_points</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update nodes with a list (pp) or a GeoDataFrame (poi) of new_points.</span>

<span class="sd">        Args:</span>
<span class="sd">            ptype: type of Point list to append, &#39;pp&#39; or &#39;poi&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create gdf of new nodes (projected PAPs)</span>
        <span class="k">if</span> <span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;pp&#39;</span><span class="p">:</span>
            <span class="n">new_nodes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">new_points</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span>
                                         <span class="n">crs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:2263&#39;</span><span class="p">})</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_nodes</span><span class="p">)</span>
            <span class="n">new_nodes</span><span class="p">[</span><span class="s1">&#39;highway&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_highway_pp</span>
            <span class="n">new_nodes</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">osmid_prefix</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

        <span class="c1"># create gdf of new nodes (original POIs)</span>
        <span class="k">elif</span> <span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;poi&#39;</span><span class="p">:</span>
            <span class="n">new_nodes</span> <span class="o">=</span> <span class="n">new_points</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">key_col</span><span class="p">]]</span>
            <span class="n">new_nodes</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;osmid&#39;</span><span class="p">]</span>
            <span class="n">new_nodes</span><span class="p">[</span><span class="s1">&#39;highway&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_highway_poi</span>
            <span class="n">new_nodes</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown ptype when updating nodes.&quot;</span><span class="p">)</span>

        <span class="c1"># merge new nodes (it is safe to ignore the index for nodes)</span>
        <span class="n">gdfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">,</span> <span class="n">new_nodes</span><span class="p">]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gdfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                 <span class="n">crs</span><span class="o">=</span><span class="n">gdfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">new_nodes</span>  <span class="c1"># all nodes, newly added nodes only</span>

    <span class="k">def</span> <span class="nf">update_edges</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">new_lines</span><span class="p">,</span> <span class="n">replace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update edge info by adding new_lines; or,</span>
<span class="sd">        replace existing ones with new_lines (n-split segments).</span>
<span class="sd">        Args:</span>
<span class="sd">            replace: treat new_lines (flat list) as newly added edges if False,</span>
<span class="sd">                     else replace existing edges with new_lines (often a nested list)</span>

<span class="sd">        Note:</span>
<span class="sd">            kne_idx refers to &#39;fid in Rtree&#39;/&#39;label&#39;/&#39;loc&#39;, not positional iloc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for interpolation (split by pp): replicate old line</span>
        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
            <span class="c1"># create a flattened gdf with all line segs and corresponding kne_idx</span>
            <span class="n">kne_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line_pps_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">lens</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="p">]</span>
            <span class="n">new_lines_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;kne_idx&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">kne_idxs</span><span class="p">,</span> <span class="n">lens</span><span class="p">),</span>
                 <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">new_lines</span><span class="p">))})</span>
            <span class="c1"># merge to inherit the data of the replaced line</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>  <span class="c1"># don&#39;t include the old geometry</span>
            <span class="n">new_edges</span> <span class="o">=</span> <span class="n">new_lines_gdf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                            <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;kne_idx&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_edges</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;kne_idx&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_lines</span> <span class="o">=</span> <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>  <span class="c1"># now a flatten list</span>
        <span class="c1"># for connection (to external poi): append new lines</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_edges</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pois</span><span class="p">[[</span><span class="n">key_col</span><span class="p">]],</span> <span class="n">geometry</span><span class="o">=</span><span class="n">new_lines</span><span class="p">,</span>
                                         <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">key_col</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
            <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;oneway&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;highway&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_highway</span>

        <span class="c1"># update features (a bit slow)</span>
        <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="p">]</span>
        <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">nodes_id_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;None&#39;</span><span class="p">))</span>
        <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">nodes_id_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;None&#39;</span><span class="p">))</span>
        <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span>
                                                       <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">])]</span>

        <span class="c1"># remember to reindex to prevent duplication when concat</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_edges</span><span class="p">)</span>
        <span class="n">new_edges</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

        <span class="c1"># for interpolation: remove existing edges</span>
        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">kne_idxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># for connection: filter invalid links</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valid_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_edges</span><span class="p">)</span>
            <span class="n">n_fault</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_pos</span><span class="p">)</span>
            <span class="n">f_pct</span> <span class="o">=</span> <span class="n">n_fault</span> <span class="o">/</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Remove faulty projections: </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_fault</span><span class="p">,</span>
                                                                      <span class="n">n</span><span class="p">,</span>
                                                                      <span class="n">f_pct</span><span class="p">))</span>
            <span class="n">new_edges</span> <span class="o">=</span> <span class="n">new_edges</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_pos</span><span class="p">]</span>  <span class="c1"># use &#39;iloc&#39; here</span>

        <span class="c1"># merge new edges</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">edges</span><span class="p">,</span> <span class="n">new_edges</span><span class="p">]</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                 <span class="n">crs</span><span class="o">=</span><span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># all edges, newly added edges only</span>
        <span class="k">return</span> <span class="n">edges</span><span class="p">,</span> <span class="n">new_edges</span>

    <span class="c1"># 0-2: configurations</span>
    <span class="c1"># set poi arguments</span>
    <span class="n">node_highway_pp</span> <span class="o">=</span> <span class="s1">&#39;projected_pap&#39;</span>  <span class="c1"># POI Access Point</span>
    <span class="n">node_highway_poi</span> <span class="o">=</span> <span class="s1">&#39;poi&#39;</span>
    <span class="n">edge_highway</span> <span class="o">=</span> <span class="s1">&#39;projected_footway&#39;</span>
    <span class="n">osmid_prefix</span> <span class="o">=</span> <span class="mi">9990000000</span>

    <span class="c1"># convert CRS</span>
    <span class="n">pois_meter</span> <span class="o">=</span> <span class="n">pois</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">2263</span><span class="p">)</span>
    <span class="n">nodes_meter</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">2263</span><span class="p">)</span>
    <span class="n">edges_meter</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">2263</span><span class="p">)</span>

    <span class="c1"># build rtree</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building rtree...&quot;</span><span class="p">)</span>
    <span class="n">Rtree</span> <span class="o">=</span> <span class="n">rtree</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">Index</span><span class="p">()</span>
    <span class="p">[</span><span class="n">Rtree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span> <span class="k">for</span> <span class="n">fid</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span>
     <span class="n">edges_meter</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()];</span>

    <span class="c1">## STAGE 1: interpolation</span>
    <span class="c1"># 1-1: update external nodes (pois)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating external nodes...&quot;</span><span class="p">)</span>
    <span class="n">nodes_meter</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">update_nodes</span><span class="p">(</span><span class="n">nodes_meter</span><span class="p">,</span> <span class="n">pois_meter</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;poi&#39;</span><span class="p">)</span>

    <span class="c1"># 1-2: update internal nodes (interpolated pps)</span>
    <span class="c1"># locate nearest edge (kne) and projected point (pp)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Projecting POIs to the network...&quot;</span><span class="p">)</span>
    <span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;near_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">Rtree</span><span class="o">.</span><span class="n">nearest</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">knn</span><span class="p">))</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span>
                              <span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>  <span class="c1"># slow</span>
    <span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;near_lines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">edges_meter</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="n">near_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">near_idx</span> <span class="ow">in</span>
                                <span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;near_idx&#39;</span><span class="p">]]</span>  <span class="c1"># very slow</span>
    <span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;kne_idx&#39;</span><span class="p">],</span> <span class="n">knes</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="o">*</span><span class="p">[</span><span class="n">find_kne</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">near_lines</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span><span class="p">,</span> <span class="n">near_lines</span> <span class="ow">in</span>
          <span class="nb">zip</span><span class="p">(</span><span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;near_lines&#39;</span><span class="p">])])</span>  <span class="c1"># slow</span>
    <span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;pp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_pp</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">kne</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span><span class="p">,</span> <span class="n">kne</span> <span class="ow">in</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">knes</span><span class="p">)]</span>

    <span class="c1"># update nodes</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating internal nodes...&quot;</span><span class="p">)</span>
    <span class="n">nodes_meter</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">update_nodes</span><span class="p">(</span><span class="n">nodes_meter</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;pp&#39;</span><span class="p">]),</span>
                                  <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;pp&#39;</span><span class="p">)</span>
    <span class="n">nodes_coord</span> <span class="o">=</span> <span class="n">nodes_meter</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nodes_id_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nodes_coord</span><span class="p">,</span> <span class="n">nodes_meter</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)))</span>

    <span class="c1"># 1-3: update internal edges (split line segments)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating internal edges...&quot;</span><span class="p">)</span>
    <span class="c1"># split</span>
    <span class="n">line_pps_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">MultiPoint</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                     <span class="n">pois_meter</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;kne_idx&#39;</span><span class="p">])[</span><span class="s1">&#39;pp&#39;</span><span class="p">]}</span>
    <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">split_line</span><span class="p">(</span><span class="n">edges_meter</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">pps</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pps</span> <span class="ow">in</span>
                 <span class="n">line_pps_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>  <span class="c1"># bit slow</span>
    <span class="n">edges_meter</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">update_edges</span><span class="p">(</span><span class="n">edges_meter</span><span class="p">,</span> <span class="n">new_lines</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">## STAGE 2: connection</span>
    <span class="c1"># 2-1: update external edges (projected footways connected to pois)</span>
    <span class="c1"># establish new_edges</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating external links...&quot;</span><span class="p">)</span>
    <span class="n">pps_gdf</span> <span class="o">=</span> <span class="n">nodes_meter</span><span class="p">[</span><span class="n">nodes_meter</span><span class="p">[</span><span class="s1">&#39;highway&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node_highway_pp</span><span class="p">]</span>
    <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">LineString</span><span class="p">([</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">])</span> <span class="k">for</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="ow">in</span>
                 <span class="nb">zip</span><span class="p">(</span><span class="n">pois_meter</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">pps_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])]</span>
    <span class="n">edges_meter</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">update_edges</span><span class="p">(</span><span class="n">edges_meter</span><span class="p">,</span> <span class="n">new_lines</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">## STAGE 3: output</span>
    <span class="c1"># convert CRS</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes_meter</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">2263</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">edges_meter</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">2263</span><span class="p">)</span>

    <span class="c1"># preprocess for pandana</span>
    <span class="n">nodes</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span>  <span class="c1"># IMPORTANT</span>
    <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
    <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>

    <span class="c1"># edges.reset_index(drop=True, inplace=True)</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># report issues</span>
    <span class="c1"># - examine key duplication</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes_meter</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes_id_dict</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOTE: duplication in node coordinates keys&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nodes count:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes_meter</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Node coordinates key count:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes_id_dict</span><span class="p">))</span>
    <span class="c1"># - examine missing nodes</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing &#39;from&#39; nodes:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing &#39;to&#39; nodes:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">]))</span>

    <span class="c1"># save and return</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/new_nodes.shp&#39;</span><span class="p">)</span>
        <span class="n">edges</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/new_edges.shp&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;new_nodes.shp and new_edges.shp are written into </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../intermediate_data/nyclion_19b/&quot;</span>
<span class="n">new_nodes</span><span class="p">,</span> <span class="n">new_edges</span> <span class="o">=</span>  <span class="n">connect_poi</span><span class="p">(</span><span class="n">points_to_add</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">key_col</span><span class="o">=</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Building rtree...
Updating external nodes...
Projecting POIs to the network...
Updating internal nodes...
Updating internal edges...
Updating external links...
Remove faulty projections: 2/3637 (0.05%)
NOTE: duplication in node coordinates keys
Nodes count: 110931
Node coordinates key count: 110868
Missing &#39;from&#39; nodes: 0
Missing &#39;to&#39; nodes: 0
new_nodes.shp and new_edges.shp are written into ../intermediate_data/nyclion_19b/
</pre></div></div>
</div>
</div>
<div class="section" id="Reading-in-the-modified-street-network">
<h2>Reading in the modified street network<a class="headerlink" href="#Reading-in-the-modified-street-network" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">shp_file</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../intermediate_data/nyclion_19b/new_edges.shp&quot;</span>
<span class="n">lion_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shp_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">shp_file</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../intermediate_data/nyclion_19b/new_edges.shp&quot;</span>
<span class="n">lion_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">read_shp</span><span class="p">(</span><span class="n">shp_file</span><span class="p">,</span> <span class="n">simplify</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">geom_attrs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">strict</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Convert-to-undirected-graph">
<h2>Convert to undirected graph<a class="headerlink" href="#Convert-to-undirected-graph" title="Permalink to this headline">¶</a></h2>
<p>And create a nodes dataframe from graph</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">G</span> <span class="o">=</span> <span class="n">lion_graph</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">convert_node_labels_to_integers</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">first_label</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">label_attribute</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">node_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
<span class="n">node_df</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_df</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Point</span><span class="p">)</span>
<span class="n">node_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">node_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
<span class="n">node_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:2263&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Locating-the-nodes-for-each-location">
<h2>Locating the nodes for each location<a class="headerlink" href="#Locating-the-nodes-for-each-location" title="Permalink to this headline">¶</a></h2>
<p>We use cDKTree to locate the nodes of the school and subways.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Create the tree</span>
<span class="c1">#coord_array = np.array(list(zip(geodataframe.geometry.x, geodataframe.geometry.y)) )</span>
<span class="c1">#tree = cKDTree(coord_array)</span>

<span class="k">def</span> <span class="nf">ckdnearest2</span><span class="p">(</span><span class="n">point_gemo</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">kneighbors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function read in a coordinate xy position, and a declared cdktree.</span>
<span class="sd">    The aim is to find the closest point to the coordinate xy position from the tree</span>
<span class="sd">    The function will return the distance between the closest point to the coordinate and the ID of that closest point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coordinate_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">point_gemo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">point_gemo</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="n">dist</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">coordinate_xy</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">kneighbors</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kneighbors</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span><span class="p">,</span> <span class="n">idx</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">coord_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">node_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">node_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">))</span> <span class="p">)</span>
<span class="n">node_tree</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">coord_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">subway</span><span class="p">[[</span><span class="s1">&#39;distance_to_node&#39;</span><span class="p">,</span><span class="s1">&#39;node_id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">subway</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">ckdnearest2</span><span class="p">(</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">node_tree</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                     <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                                     <span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;expand&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">subway</span><span class="p">[</span><span class="s1">&#39;distance_to_node&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>0    1928
Name: distance_to_node, dtype: int64
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">subway</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;distance_to_node&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="p">[[</span><span class="s1">&#39;distance_to_node&#39;</span><span class="p">,</span><span class="s1">&#39;node_id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">schools</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">ckdnearest2</span><span class="p">(</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">node_tree</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                        <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;expand&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;distance_to_node&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>0        1707
21949       1
11187       1
Name: distance_to_node, dtype: int64
</pre></div>
</div>
</div>
<p>There are two schools that are really far when they should be at a distance of zero from the nodes. Recall when I ran the <code class="docutils literal notranslate"><span class="pre">connect_poi()</span></code> function that it <code class="docutils literal notranslate"><span class="pre">Remove</span> <span class="pre">faulty</span> <span class="pre">projections:</span> <span class="pre">2/3637</span> <span class="pre">(0.05%)</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1">#new_edges.plot(ax=ax)</span>
<span class="n">schools</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;distance_to_node&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x14a6824de48&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/Network_distance_example_61_1.png" src="_images/Network_distance_example_61_1.png" />
</div>
</div>
<p>Remove schools that are not in NYC</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span> <span class="o">=</span> <span class="n">schools</span><span class="p">[</span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;distance_to_node&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;distance_to_node&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Finding-the-nearest-2-subway-entrances">
<h2>Finding the nearest 2 subway entrances<a class="headerlink" href="#Finding-the-nearest-2-subway-entrances" title="Permalink to this headline">¶</a></h2>
<p>Now we want to find the closest 2 subway entrances to each school</p>
<p>Set up the tree for subway location</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">coord_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">subway</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">subway</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">))</span> <span class="p">)</span>
<span class="n">subway_tree</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">coord_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="p">[[</span><span class="s1">&#39;distance_to_subway_nodes&#39;</span><span class="p">,</span><span class="s1">&#39;subway_ids&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">schools</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">ckdnearest2</span><span class="p">(</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">subway_tree</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                                        <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;expand&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Parse out the subway_node_ids</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;closest_subway_id1&#39;</span><span class="p">],</span> <span class="n">schools</span><span class="p">[</span><span class="s1">&#39;closest_subway_id2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;subway_ids&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ATS_CODE</th>
      <th>BORO</th>
      <th>BORONUM</th>
      <th>LOC_CODE</th>
      <th>SCHOOLNAME</th>
      <th>SCH_TYPE</th>
      <th>MANAGED_BY</th>
      <th>GEO_DISTRI</th>
      <th>ADMIN_DIST</th>
      <th>ADDRESS</th>
      <th>...</th>
      <th>PRIN_PH</th>
      <th>FAX</th>
      <th>GRADES</th>
      <th>City</th>
      <th>geometry</th>
      <th>node_id</th>
      <th>distance_to_subway_nodes</th>
      <th>subway_ids</th>
      <th>closest_subway_id1</th>
      <th>closest_subway_id2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>15K001</td>
      <td>K</td>
      <td>2.0</td>
      <td>K001</td>
      <td>P.S. 001 THE BERGEN</td>
      <td>Elementary</td>
      <td>1</td>
      <td>15</td>
      <td>15</td>
      <td>309 47 STREET</td>
      <td>...</td>
      <td>718-567-7661</td>
      <td>718-567-9771</td>
      <td>PK,0K,01,02,03,04,05,SE</td>
      <td>BROOKLYN</td>
      <td>POINT (980985.0541713729 175780.758994163)</td>
      <td>109165</td>
      <td>[574.0166423762518, 617.2474703341181]</td>
      <td>[1744, 1746]</td>
      <td>1744</td>
      <td>1746</td>
    </tr>
    <tr>
      <th>1</th>
      <td>17K002</td>
      <td>K</td>
      <td>2.0</td>
      <td>K002</td>
      <td>M.S. 002</td>
      <td>Junior High-Intermediate-Middle</td>
      <td>1</td>
      <td>17</td>
      <td>17</td>
      <td>655 PARKSIDE AVENUE</td>
      <td>...</td>
      <td>718-462-6992</td>
      <td>718-284-7717</td>
      <td>06,07,08,SE</td>
      <td>BROOKLYN</td>
      <td>POINT (997785.1364296663 178431.910832498)</td>
      <td>109166</td>
      <td>[258.5002370023575, 442.8355620846949]</td>
      <td>[1349, 749]</td>
      <td>1349</td>
      <td>749</td>
    </tr>
    <tr>
      <th>2</th>
      <td>21K095</td>
      <td>K</td>
      <td>2.0</td>
      <td>K095</td>
      <td>P.S. 095 THE GRAVESEND</td>
      <td>K-8</td>
      <td>1</td>
      <td>21</td>
      <td>21</td>
      <td>345 VAN SICKLEN STREET</td>
      <td>...</td>
      <td>718-449-5050</td>
      <td>718-449-3047</td>
      <td>PK,0K,01,02,03,04,05,06,07,08,SE</td>
      <td>BROOKLYN</td>
      <td>POINT (991224.9830063033 156323.3612131244)</td>
      <td>109167</td>
      <td>[431.5770408752747, 492.43651609913985]</td>
      <td>[1522, 1591]</td>
      <td>1522</td>
      <td>1591</td>
    </tr>
    <tr>
      <th>3</th>
      <td>21K096</td>
      <td>K</td>
      <td>2.0</td>
      <td>K096</td>
      <td>I.S. 096 SETH LOW</td>
      <td>Junior High-Intermediate-Middle</td>
      <td>1</td>
      <td>21</td>
      <td>21</td>
      <td>99 AVENUE P</td>
      <td>...</td>
      <td>718-236-1344</td>
      <td>718-236-2397</td>
      <td>06,07,08,SE</td>
      <td>BROOKLYN</td>
      <td>POINT (988439.6813609767 160709.9926236183)</td>
      <td>109168</td>
      <td>[1366.7287949334989, 1549.5096241139383]</td>
      <td>[443, 203]</td>
      <td>443</td>
      <td>203</td>
    </tr>
    <tr>
      <th>4</th>
      <td>21K097</td>
      <td>K</td>
      <td>2.0</td>
      <td>K097</td>
      <td>P.S. 97 THE HIGHLAWN</td>
      <td>Elementary</td>
      <td>1</td>
      <td>21</td>
      <td>21</td>
      <td>1855 STILLWELL AVENUE</td>
      <td>...</td>
      <td>718-372-7393</td>
      <td>718-372-3842</td>
      <td>PK,0K,01,02,03,04,05,SE</td>
      <td>BROOKLYN</td>
      <td>POINT (988205.0729096507 158329.5913366843)</td>
      <td>109169</td>
      <td>[1224.1544066200531, 1270.3197366749077]</td>
      <td>[190, 189]</td>
      <td>190</td>
      <td>189</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">subway</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>line</th>
      <th>name</th>
      <th>objectid</th>
      <th>url</th>
      <th>geometry</th>
      <th>node_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>2-5</td>
      <td>Birchall Ave &amp; Sagamore St at NW corner</td>
      <td>1734.0</td>
      <td>http://web.mta.info/nyct/service/</td>
      <td>POINT (1020670.668616476 248679.9905504963)</td>
      <td>107248</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2-5</td>
      <td>Birchall Ave &amp; Sagamore St at NE corner</td>
      <td>1735.0</td>
      <td>http://web.mta.info/nyct/service/</td>
      <td>POINT (1020710.253511059 248665.112299423)</td>
      <td>107249</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>2-5</td>
      <td>Morris Park Ave &amp; 180th St at NW corner</td>
      <td>1736.0</td>
      <td>http://web.mta.info/nyct/service/</td>
      <td>POINT (1019251.986414479 245782.8697043241)</td>
      <td>107250</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>2-5</td>
      <td>Morris Park Ave &amp; 180th St at NW corner</td>
      <td>1737.0</td>
      <td>http://web.mta.info/nyct/service/</td>
      <td>POINT (1019419.817771734 245866.9102186682)</td>
      <td>107251</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>2-5</td>
      <td>Boston Rd &amp; 178th St at SW corner</td>
      <td>1738.0</td>
      <td>http://web.mta.info/nyct/service/</td>
      <td>POINT (1017557.721758398 245631.8322767556)</td>
      <td>107252</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Merging in the respective node_ids for the nearest subway locations</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span> <span class="o">=</span> <span class="n">schools</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">subway</span><span class="p">[[</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="s1">&#39;node_id&#39;</span><span class="p">]],</span>
                        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span>
                        <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;closest_subway_id1&#39;</span><span class="p">,</span>
                        <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">schools</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;node_id_y&quot;</span><span class="p">:</span> <span class="s2">&quot;subway_node_id1&quot;</span><span class="p">},</span><span class="n">inplace</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span> <span class="o">=</span> <span class="n">schools</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">subway</span><span class="p">[[</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="s1">&#39;node_id&#39;</span><span class="p">]],</span>
                        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span>
                        <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;closest_subway_id2&#39;</span><span class="p">,</span>
                        <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">schools</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;node_id&quot;</span><span class="p">:</span> <span class="s2">&quot;subway_node_id2&quot;</span><span class="p">},</span><span class="n">inplace</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;node_id_x&quot;</span><span class="p">:</span> <span class="s2">&quot;node_id&quot;</span><span class="p">},</span><span class="n">inplace</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">network_distance</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node_gdf</span><span class="p">,</span> <span class="n">origin_node</span><span class="p">,</span> <span class="n">target_node</span><span class="p">,</span> <span class="n">weight_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    graph is the networkx graph</span>
<span class="sd">    node_gdf is the geodataframe of nodes. This will allow us to create the LineString.</span>
<span class="sd">    origin_node is the starting node to begin the network distance</span>
<span class="sd">    target_node is the end node to end the network distance</span>
<span class="sd">    weight is the distance measure</span>

<span class="sd">    We use the shortest_path function from networkx.</span>
<span class="sd">    Use the nodes on the shortest path and extract the coordinates from the node_gdf</span>
<span class="sd">    Use the geometry from the route_nodes to create the line string</span>
<span class="sd">    From the line string we will extract the length</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">route</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">origin_node</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target_node</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">weight_name</span><span class="p">)</span>
        <span class="n">route_nodes</span> <span class="o">=</span> <span class="n">node_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">route</span><span class="p">]</span>
        <span class="n">route_line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">route_nodes</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">route_line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">()</span>

    <span class="n">route_line_dist</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">route_line</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">route_line</span><span class="p">,</span> <span class="n">route_line_dist</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Network-distance">
<h2>Network distance<a class="headerlink" href="#Network-distance" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">schools</span><span class="p">[[</span><span class="s1">&#39;route1_geom&#39;</span><span class="p">,</span> <span class="s1">&#39;route1_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">schools</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">network_distance</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">node_gdf</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">],</span> <span class="n">target_node</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;subway_node_id1&#39;</span><span class="p">],</span><span class="n">weight_name</span> <span class="o">=</span> <span class="s1">&#39;weight&#39;</span><span class="p">),</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;expand&#39;</span><span class="p">)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">time_difference</span> <span class="o">=</span> <span class="p">(((</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It took </span><span class="si">{0}</span><span class="s2"> hours&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_difference</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
It took 0.002848712139659458 hours
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">schools</span><span class="p">[[</span><span class="s1">&#39;route2_geom&#39;</span><span class="p">,</span> <span class="s1">&#39;route2_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">schools</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">network_distance</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">node_gdf</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">],</span> <span class="n">target_node</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;subway_node_id2&#39;</span><span class="p">],</span><span class="n">weight_name</span> <span class="o">=</span> <span class="s1">&#39;weight&#39;</span><span class="p">),</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">result_type</span> <span class="o">=</span> <span class="s1">&#39;expand&#39;</span><span class="p">)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">time_difference</span> <span class="o">=</span> <span class="p">(((</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It took </span><span class="si">{0}</span><span class="s2"> hours&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_difference</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
It took 0.0029577416181564334 hours
</pre></div></div>
</div>
<p>Determine which route is shorter between the two</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route1_dist&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route2_dist&#39;</span><span class="p">]),</span> <span class="s1">&#39;shortest_network_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route1_dist&#39;</span><span class="p">]</span>
<span class="n">schools</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route1_dist&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route2_dist&#39;</span><span class="p">])</span> <span class="p">,</span> <span class="s1">&#39;shortest_network_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route2_dist&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route1_dist&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route2_dist&#39;</span><span class="p">]),</span> <span class="s1">&#39;shortest_network_geom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route1_geom&#39;</span><span class="p">]</span>
<span class="n">schools</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route1_dist&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route2_dist&#39;</span><span class="p">]),</span> <span class="s1">&#39;shortest_network_geom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route2_geom&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;route1_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>False    1707
Name: route1_dist, dtype: int64
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>Index([&#39;ATS_CODE&#39;, &#39;BORO&#39;, &#39;BORONUM&#39;, &#39;LOC_CODE&#39;, &#39;SCHOOLNAME&#39;, &#39;SCH_TYPE&#39;,
       &#39;MANAGED_BY&#39;, &#39;GEO_DISTRI&#39;, &#39;ADMIN_DIST&#39;, &#39;ADDRESS&#39;, &#39;STATE_CODE&#39;,
       &#39;ZIP&#39;, &#39;PRINCIPAL&#39;, &#39;PRIN_PH&#39;, &#39;FAX&#39;, &#39;GRADES&#39;, &#39;City&#39;, &#39;geometry&#39;,
       &#39;node_id&#39;, &#39;distance_to_subway_nodes&#39;, &#39;subway_ids&#39;,
       &#39;closest_subway_id1&#39;, &#39;closest_subway_id2&#39;, &#39;subway_node_id1&#39;,
       &#39;subway_node_id2&#39;, &#39;route1_geom&#39;, &#39;route1_dist&#39;, &#39;route2_geom&#39;,
       &#39;route2_dist&#39;, &#39;shortest_network_distance&#39;, &#39;shortest_network_geom&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">schools</span><span class="p">[[</span><span class="s1">&#39;node_id&#39;</span><span class="p">,</span><span class="s1">&#39;subway_node_id1&#39;</span><span class="p">,</span><span class="s1">&#39;subway_node_id2&#39;</span><span class="p">,</span><span class="s1">&#39;route1_geom&#39;</span><span class="p">,</span><span class="s1">&#39;route1_dist&#39;</span><span class="p">,</span><span class="s1">&#39;route2_geom&#39;</span><span class="p">,</span><span class="s1">&#39;route2_dist&#39;</span><span class="p">,</span><span class="s1">&#39;shortest_network_distance&#39;</span><span class="p">,</span><span class="s1">&#39;shortest_network_geom&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">schools</span><span class="p">[</span><span class="s1">&#39;shortest_network_distance&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>node_id</th>
      <th>subway_node_id1</th>
      <th>subway_node_id2</th>
      <th>route1_geom</th>
      <th>route1_dist</th>
      <th>route2_geom</th>
      <th>route2_dist</th>
      <th>shortest_network_distance</th>
      <th>shortest_network_geom</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>993</th>
      <td>110157</td>
      <td>108875</td>
      <td>107599</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
      <td>0</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
      <td>0</td>
      <td>0.0</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
    </tr>
    <tr>
      <th>1018</th>
      <td>110182</td>
      <td>108875</td>
      <td>107599</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
      <td>0</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
      <td>0</td>
      <td>0.0</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
    </tr>
    <tr>
      <th>1042</th>
      <td>110206</td>
      <td>108871</td>
      <td>107599</td>
      <td>LINESTRING (929431.2955717515 137631.694279956...</td>
      <td>4601</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
      <td>0</td>
      <td>0.0</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
    </tr>
    <tr>
      <th>1613</th>
      <td>110772</td>
      <td>108750</td>
      <td>107347</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
      <td>0</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
      <td>0</td>
      <td>0.0</td>
      <td>GEOMETRYCOLLECTION EMPTY</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../intermediate_data/school_subway_route.shp&quot;</span>
<span class="n">schools</span> <span class="o">=</span> <span class="n">schools</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="s1">&#39;shortest_network_geom&#39;</span><span class="p">)</span>
<span class="n">schools</span><span class="p">[[</span><span class="s1">&#39;node_id&#39;</span><span class="p">,</span><span class="s1">&#39;shortest_network_geom&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../intermediate_data/school.shp&quot;</span>
<span class="n">schools</span> <span class="o">=</span> <span class="n">schools</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
<span class="n">schools</span><span class="p">[[</span><span class="s1">&#39;node_id&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../intermediate_data/subway.shp&quot;</span>
<span class="n">subway</span> <span class="o">=</span> <span class="n">subway</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
<span class="n">subway</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Plot-the-schools,-subway-and-routes">
<h2>Plot the schools, subway and routes<a class="headerlink" href="#Plot-the-schools,-subway-and-routes" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

<span class="n">schools</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;school&#39;</span><span class="p">)</span>
<span class="n">subway</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;subway&#39;</span><span class="p">)</span>
<span class="n">schools</span> <span class="o">=</span> <span class="n">schools</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="s1">&#39;shortest_network_geom&#39;</span><span class="p">)</span>
<span class="n">schools</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;school routes&#39;</span><span class="p">)</span>
<span class="c1">#Set default back</span>
<span class="n">schools</span> <span class="o">=</span> <span class="n">schools</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Routes from NYC schools to nearest subway entrance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/Network_distance_example_94_0.png" src="_images/Network_distance_example_94_0.png" />
</div>
</div>
<p>I can see that there are 3 blue dots in Staten Island that should have a route drawn, but the networkx shortest path function did not find a path for these origin nodes. Need to figure out why. The other blue dot south of Manhattan is on Governors island.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="networkdistance_lion-issues.html" class="btn btn-neutral float-right" title="Network Distance with LION map (weight)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="networkdistance_lion.html" class="btn btn-neutral float-left" title="Network Distance with LION map" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sze, J.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>